<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>G√∂rev Planlayƒ±cƒ± (G√ºncel)</title>

  <style>
    :root{
      --primary:#007AFF;
      --bg:#F2F2F7;
      --card:#FFFFFF;
      --text:#1C1C1E;
      --muted:#8E8E93;
      --danger:#FF3B30;
      --ok:#16A34A;
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;color:var(--text)}
    .wrap{max-width:720px;margin:28px auto;padding:18px}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
    h1{margin:0 0 12px 0;font-size:20px}
    .input-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    input,textarea,button,select{font-size:15px;padding:10px;border-radius:8px;border:1px solid #D1D1D6}
    input[type="text"]{flex:1 1 240px}
    textarea{width:100%;min-height:70px;resize:vertical}
    input[type="datetime-local"]{min-width:220px}
    .add-btn{background:var(--primary);color:#fff;border:none;cursor:pointer}
    ul{list-style:none;padding:0;margin:12px 0 0 0}
    li{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;padding:12px;border-radius:8px;background:#fff;border:1px solid #eee;margin-bottom:10px;transition:all .15s}
    .li-left{flex:1}
    .title{font-weight:700;margin-bottom:6px}
    .title.done{color:var(--ok);text-decoration:none}
    .desc{color:#333;margin-bottom:8px}
    .meta{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px;align-items:center}
    button.action{padding:6px 10px;border-radius:6px;border:none;cursor:pointer}
    button.delete{background:#FFF0F0;color:var(--danger)}
    button.done{background:#E8F8EE;color:var(--ok)}
    button.outlook{background:#eef6ff;color:var(--primary);border:1px solid #d6eaff}
    .overdue{border-left:6px solid var(--danger)}
    .alerted-badge{background:#FFF0F0;color:var(--danger);padding:3px 8px;border-radius:999px;font-size:12px;margin-left:6px}
    .small{font-size:13px;color:var(--muted)}
    .notice{font-size:13px;color:var(--muted);margin-bottom:8px}
    @media (max-width:600px){
      .input-row{flex-direction:column}
      input[type="datetime-local"]{width:100%}
    }
  </style>

  <!-- MSAL for Outlook (optional) -->
  <script src="https://alcdn.msauth.net/browser/2.28.1/js/msal-browser.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üìù G√∂rev Planlayƒ±cƒ±</h1>

      <div class="notice">Bildirimler i√ßin tarayƒ±cƒ± izin verin. (Sayfa a√ßƒ±kken alarm/bildirim √ßalƒ±≈üƒ±r.)</div>

      <div class="input-row">
        <input id="titleInp" type="text" placeholder="Konu Ba≈ülƒ±ƒüƒ±" />
        <input id="datetimeInp" type="datetime-local" />
        <button id="addBtn" class="add-btn">Listeye Kaydet</button>
      </div>

      <textarea id="descInp" placeholder="Detaylar (opsiyonel)"></textarea>

      <div style="margin-top:10px" class="small">Outlook ile takvime eklemek i√ßin "Outlook'a Ekle" tu≈üunu kullanƒ±n (ilk kullanƒ±mda Microsoft ile oturum a√ßmanƒ±z istenir).</div>

      <ul id="list"></ul>
    </div>
  </div>

<script>
/*
  √ñzellikler uygulandƒ±:
  - Tarih + saat: datetime-local input.
  - Eklenen g√∂revler en √ºstte g√∂z√ºk√ºr.
  - Se√ßilen tarih/saat yakla≈üƒ±nca bildirim + ses.
  - S√ºresi ge√ßmi≈ü ve i≈ülem yapƒ±lmamƒ±≈ü g√∂revler kƒ±rmƒ±zƒ± (overdue).
  - "Tamamlandƒ±" yaptƒ±ƒüƒ±nƒ±zda ba≈ülƒ±k ye≈üile d√∂n√º≈ü√ºr (√ºst√º √ßizili olmaz).
  - Outlook entegrasyonu i√ßin MSAL iskeleti eklendi (OUTLOOK_CLIENT_ID doldurun).
*/

const STORAGE_KEY = 'ios_todo_v3';
const NOTIFY_THRESHOLD_MIN = 5; // yakla≈üma bildirimi e≈üiƒüi (dakika)
const CHECK_INTERVAL_MS = 30 * 1000; // periyodik kontrol
const MAX_TIMEOUT = 2147483647; // setTimeout limit

const listEl = document.getElementById('list');
const titleInp = document.getElementById('titleInp');
const descInp = document.getElementById('descInp');
const datetimeInp = document.getElementById('datetimeInp');
const addBtn = document.getElementById('addBtn');

let tasks = [];
let scheduled = {}; // key -> timeoutId

// alarm sesi (public kaynak)
const alarmAudio = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
alarmAudio.preload = 'auto';

// Outlook (MSAL) - doldurulmasƒ± gereken yer
const OUTLOOK_CLIENT_ID = ""; // <-- Azure App Registration'dan alƒ±n (bo≈ü bƒ±rakƒ±lƒ±rsa Outlook kapalƒ± kalƒ±r)
const OUTLOOK_SCOPES = ["Calendars.ReadWrite"];
let msalInstance = null;
let msalAccount = null;
if (OUTLOOK_CLIENT_ID) {
  msalInstance = new msal.PublicClientApplication({
    auth: { clientId: OUTLOOK_CLIENT_ID, redirectUri: window.location.origin + window.location.pathname }
  });
  const accs = msalInstance.getAllAccounts();
  if (accs && accs.length) msalAccount = accs[0];
}

// Y√ºkle
window.addEventListener('load', () => {
  try {
    tasks = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    if (!Array.isArray(tasks)) tasks = [];
  } catch(e) {
    console.error('localStorage parse error', e);
    localStorage.removeItem(STORAGE_KEY);
    tasks = [];
  }
  // render
  refreshList();
  requestNotificationPermission();
  scheduleAll();
  setInterval(() => {
    updateOverdueUI();
    scheduleAll();
  }, CHECK_INTERVAL_MS);
});

// Ekle
addBtn.addEventListener('click', addTask);
titleInp.addEventListener('keydown', e => { if (e.key === 'Enter') addTask(); });

function addTask(){
  const title = titleInp.value.trim();
  if (!title) { alert('L√ºtfen bir ba≈ülƒ±k girin!'); return; }
  const desc = descInp.value.trim();
  const datetimeVal = datetimeInp.value || '';
  const deadlineISO = datetimeVal ? (new Date(datetimeVal)).toISOString() : '';
  const created = new Date().toLocaleString();

  const task = {
    id: 't_' + Date.now() + '_' + Math.random().toString(36).slice(2,7),
    title,
    desc: desc || '',
    created,
    deadline: deadlineISO,
    done: false,
    alerted: false
  };

  tasks.unshift(task);
  save();
  // render this item at top
  renderTask(task, true);
  scheduleForTask(task);

  // clear inputs
  titleInp.value = '';
  descInp.value = '';
  datetimeInp.value = '';
}

// Save
function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
}

// Render helpers
function renderTask(task, toTop = true){
  const li = document.createElement('li');
  li.dataset.id = task.id;
  if (isOverdue(task) && !task.done) li.classList.add('overdue');

  // left
  const left = document.createElement('div');
  left.className = 'li-left';

  const titleDiv = document.createElement('div');
  titleDiv.className = 'title' + (task.done ? ' done' : '');
  titleDiv.textContent = task.title;
  left.appendChild(titleDiv);

  if (task.desc) {
    const descDiv = document.createElement('div');
    descDiv.className = 'desc';
    descDiv.textContent = task.desc;
    left.appendChild(descDiv);
  }

  const metaDiv = document.createElement('div');
  metaDiv.className = 'meta';
  let deadlineText = '';
  if (task.deadline) {
    const d = new Date(task.deadline);
    if (!isNaN(d)) deadlineText = ' ‚Ä¢ Hedef: ' + d.toLocaleString();
  }
  metaDiv.innerHTML = `<b>Olu≈üturma:</b> ${task.created}${deadlineText}`;
  left.appendChild(metaDiv);

  // right actions
  const right = document.createElement('div');
  right.className = 'actions';

  if (task.alerted) {
    const badge = document.createElement('span');
    badge.className = 'alerted-badge';
    badge.textContent = 'Bildirim G√∂nderildi';
    right.appendChild(badge);
  }

  const doneBtn = document.createElement('button');
  doneBtn.className = 'action done';
  doneBtn.textContent = task.done ? 'Geri Al' : 'Tamamlandƒ±';
  doneBtn.onclick = (e) => { e.stopPropagation(); toggleDone(task.id); };
  right.appendChild(doneBtn);

  const delBtn = document.createElement('button');
  delBtn.className = 'action delete';
  delBtn.textContent = 'Sil';
  delBtn.onclick = (e) => { e.stopPropagation(); deleteTask(task.id); };
  right.appendChild(delBtn);

  const outBtn = document.createElement('button');
  outBtn.className = 'action outlook';
  outBtn.textContent = "Outlook'a Ekle";
  outBtn.onclick = async (e) => { e.stopPropagation(); try { await createOutlookEvent(task); alert('Outlook takviminize eklendi.'); } catch(err){ console.error(err); alert('Outlook eklenemedi. Konsolu kontrol edin.'); } };
  right.appendChild(outBtn);

  li.appendChild(left);
  li.appendChild(right);

  if (toTop && listEl.firstChild) listEl.insertBefore(li, listEl.firstChild);
  else listEl.appendChild(li);
}

function refreshList(){
  listEl.innerHTML = '';
  tasks.forEach(t => renderTask(t, false));
  updateOverdueUI();
}

// Delete
function deleteTask(id){
  tasks = tasks.filter(t => t.id !== id);
  save();
  const el = document.querySelector('li[data-id="'+id+'"]');
  if (el) el.remove();
  // clear scheduled timeouts for that task
  Object.keys(scheduled).forEach(k => { if (k.startsWith(id+'_')) { clearTimeout(scheduled[k]); delete scheduled[k]; } });
}

// Done toggle
function toggleDone(id){
  const t = tasks.find(x => x.id === id);
  if (!t) return;
  t.done = !t.done;
  save();
  refreshList();
  // if marked done, clear related scheduled notifications
  if (t.done) {
    Object.keys(scheduled).forEach(k => { if (k.startsWith(id+'_')) { clearTimeout(scheduled[k]); delete scheduled[k]; } });
  } else {
    scheduleForTask(t);
  }
}

// Overdue check
function isOverdue(task){
  if (!task.deadline) return false;
  const d = new Date(task.deadline);
  if (isNaN(d)) return false;
  return Date.now() > d.getTime();
}

function updateOverdueUI(){
  tasks.forEach(t => {
    const el = document.querySelector('li[data-id="'+t.id+'"]');
    if (!el) return;
    if (isOverdue(t) && !t.done) el.classList.add('overdue'); else el.classList.remove('overdue');
    const titleEl = el.querySelector('.title');
    if (t.done) titleEl.classList.add('done'); else titleEl.classList.remove('done');
    // alerted badge
    const hasBadge = !!el.querySelector('.alerted-badge');
    if (t.alerted && !hasBadge) {
      const badge = document.createElement('span'); badge.className='alerted-badge'; badge.textContent='Bildirim G√∂nderildi';
      el.querySelector('.actions').insertBefore(badge, el.querySelector('.actions').firstChild);
    } else if (!t.alerted && hasBadge) {
      const b = el.querySelector('.alerted-badge'); if (b) b.remove();
    }
  });
}

/* Notification permission */
async function requestNotificationPermission(){
  if (!('Notification' in window)) return;
  if (Notification.permission === 'default') {
    try { await Notification.requestPermission(); } catch(e){ console.warn(e); }
  }
}

/* Scheduling */
function scheduleForTask(task){
  if (!task.deadline || task.done || task.alerted) return;
  const d = new Date(task.deadline);
  if (isNaN(d)) return;
  const now = Date.now();
  const deadlineMs = d.getTime();
  const notifyAt = deadlineMs - NOTIFY_THRESHOLD_MIN * 60 * 1000;
  [notifyAt, deadlineMs].forEach(time => {
    if (time <= now) return;
    const delay = time - now;
    if (delay > MAX_TIMEOUT) return; // √ßok uzaksa atlama (periyodik scheduleAll tekrar dener)
    const key = task.id + '_' + time;
    if (scheduled[key]) return;
    scheduled[key] = setTimeout(() => {
      // yeniden kontrol
      const cur = tasks.find(x => x.id === task.id);
      if (!cur || cur.done) { clearTimeout(scheduled[key]); delete scheduled[key]; return; }
      // Bildirim + ses
      sendAlarm(cur);
      cur.alerted = true;
      save();
      updateOverdueUI();
      clearTimeout(scheduled[key]); delete scheduled[key];
    }, delay);
  });
}

function scheduleAll(){
  // temizle √∂nce
  Object.keys(scheduled).forEach(k => { clearTimeout(scheduled[k]); delete scheduled[k]; });
  tasks.forEach(t => scheduleForTask(t));
}

/* Alarm function */
function sendAlarm(task){
  try {
    if ('Notification' in window && Notification.permission === 'granted') {
      const n = new Notification('G√∂rev hatƒ±rlatmasƒ±', {
        body: task.title + (task.deadline ? ' ‚Ä¢ ' + (new Date(task.deadline)).toLocaleString() : ''),
        tag: task.id,
        renotify: false
      });
      n.onclick = () => window.focus();
    } else {
      // izin yoksa fallback
      // not ideal but user will see alert
      alert('Hatƒ±rlatma: ' + task.title);
    }
  } catch(e){
    console.error('Notification error', e);
  }
  try { alarmAudio.currentTime = 0; alarmAudio.play().catch(()=>{}); } catch(e){}
}

/* Storage listener (diƒüer sekmelerde yapƒ±lan deƒüi≈üikliklere tepki) */
window.addEventListener('storage', e => {
  if (e.key === STORAGE_KEY) {
    try { tasks = JSON.parse(e.newValue || '[]'); } catch(e){ tasks = []; }
    scheduleAll();
    refreshList();
  }
});

/* Outlook / MS Graph (iskelet) */
async function ensureMsalLogin(){
  if (!msalInstance) throw new Error('OUTLOOK_CLIENT_ID bo≈ü - Outlook entegrasyonu devre dƒ±≈üƒ±.');
  if (!msalAccount) {
    const resp = await msalInstance.loginPopup({ scopes: OUTLOOK_SCOPES });
    msalAccount = resp.account;
  }
  return msalAccount;
}

async function getAccessToken(){
  if (!msalInstance) throw new Error('OUTLOOK_CLIENT_ID bo≈ü - Outlook entegrasyonu devre dƒ±≈üƒ±.');
  const req = { scopes: OUTLOOK_SCOPES, account: msalAccount };
  try {
    const resp = await msalInstance.acquireTokenSilent(req);
    return resp.accessToken;
  } catch(e){
    const resp = await msalInstance.acquireTokenPopup(req);
    return resp.accessToken;
  }
}

async function createOutlookEvent(task){
  if (!task) throw new Error('Task bulunamadƒ±');
  await ensureMsalLogin();
  const token = await getAccessToken();
  const start = task.deadline ? new Date(task.deadline) : new Date();
  const end = new Date(start.getTime() + 30*60000);
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
  const event = {
    subject: task.title,
    body: { contentType: 'Text', content: task.desc || '' },
    start: { dateTime: start.toISOString(), timeZone: tz },
    end: { dateTime: end.toISOString(), timeZone: tz }
  };
  const resp = await fetch('https://graph.microsoft.com/v1.0/me/events', {
    method: 'POST',
    headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
    body: JSON.stringify(event)
  });
  if (!resp.ok) throw new Error('Graph API error: ' + resp.status + ' ' + await resp.text());
  return resp.json();
}

/* Utility: temizleme (kullanƒ±cƒ± isteƒüe baƒülƒ±) */
window.debug_clearAll = function(){
  localStorage.removeItem(STORAGE_KEY);
  tasks = [];
  refreshList();
};

</script>
</body>
</html>
