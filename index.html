<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>G√∂rev Planlayƒ±cƒ± (G√ºncel)</title>

  <style>
    :root{
      --primary:#007AFF;
      --bg:#F2F2F7;
      --card:#FFFFFF;
      --text:#1C1C1E;
      --muted:#8E8E93;
      --danger:#FF3B30;
      --ok:#16A34A;
      --border:#D1D1D6;
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;color:var(--text)}
    .wrap{max-width:720px;margin:28px auto;padding:18px}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
    h1{margin:0 0 12px 0;font-size:20px}
    .notice{font-size:13px;color:var(--muted);margin-bottom:10px}

    .input-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
    input,textarea,button,select{font-size:15px;padding:10px;border-radius:8px;border:1px solid var(--border);background:#fff}
    /* Ba≈ülƒ±k alanƒ± k√º√ß√ºk */
    input#titleInp{width:220px;flex:0 0 auto}
    input[type="datetime-local"]{min-width:220px}
    textarea{width:100%;min-height:70px;resize:vertical}

    .sub-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center}
    .sub-row input{flex:1 1 260px}

    .add-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center}
    .add-btn{background:var(--primary);color:#fff;border:none;cursor:pointer;padding:10px 14px}
    .hint{font-size:13px;color:var(--muted)}

    /* Ara / filtre / sƒ±ralama */
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;align-items:center}
    .toolbar input[type="text"]{flex:1 1 220px}
    .toolbar select{min-width:160px}
    .ghost{background:#fff;border:1px solid var(--border);cursor:pointer}
    .summary{margin-top:10px;font-size:13px;color:var(--muted)}

    ul{list-style:none;padding:0;margin:12px 0 0 0}
    li{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;padding:12px;border-radius:8px;background:#fff;border:1px solid #eee;margin-bottom:10px;transition:all .15s}
    .li-left{flex:1}
    .title{font-weight:700;margin-bottom:6px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .title.done{color:var(--ok);text-decoration:none}
    .desc{color:#333;margin-bottom:8px;white-space:pre-wrap}
    .meta{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}

    .chip{
      font-size:12px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #e5e5ea;
      background:#fafafa;
      color:#333;
    }
    .chip.prio-high{border-color:#ffd5d2;background:#fff6f6}
    .chip.prio-med{border-color:#e5e5ea;background:#fafafa}
    .chip.prio-low{border-color:#d6eaff;background:#f4f9ff}
    .chip.people{border-color:#d7f0e0;background:#f4fff8;color:#0f6b36}

    .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button.action{padding:6px 10px;border-radius:6px;border:none;cursor:pointer}
    button.delete{background:#FFF0F0;color:var(--danger)}
    button.done{background:#E8F8EE;color:var(--ok)}
    button.edit{background:#fff8e6;color:#9a6700;border:1px solid #ffe0a3}
    button.save{background:#e9f7ff;color:#0b63d1;border:1px solid #cfe8ff}
    button.cancel{background:#f2f2f7;color:#444;border:1px solid #e5e5ea}
    button.calendar{background:#f5f0ff;color:#5b2bd6;border:1px solid #e6dbff}
    button.share{background:#eafff7;color:#0f6b36;border:1px solid #c9f2df}
    button.outlook{background:#eef6ff;color:var(--primary);border:1px solid #d6eaff}

    .overdue{border-left:6px solid var(--danger)}
    .alerted-badge{background:#FFF0F0;color:var(--danger);padding:3px 8px;border-radius:999px;font-size:12px}

    .edit-panel{
      margin-top:10px;
      padding:10px;
      border:1px dashed #e5e5ea;
      border-radius:10px;
      background:#fbfbfd;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .edit-row{display:flex;gap:8px;flex-wrap:wrap}
    .edit-row input[type="text"]{flex:1 1 220px}
    .edit-row input[type="datetime-local"]{min-width:220px}

    @media (max-width:600px){
      input#titleInp{width:100%}
      .input-row{flex-direction:column;align-items:stretch}
      input[type="datetime-local"]{width:100%}
      .sub-row{flex-direction:column;align-items:stretch}
      .add-row{flex-direction:column;align-items:stretch}
      .toolbar{flex-direction:column;align-items:stretch}
      .toolbar select{width:100%}
      .edit-row{flex-direction:column}
      .edit-row input[type="datetime-local"]{width:100%}
    }
  </style>

  <!-- MSAL for Outlook (opsiyonel) -->
  <script src="https://alcdn.msauth.net/browser/2.28.1/js/msal-browser.min.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>üìù G√∂rev Planlayƒ±cƒ±</h1>
      <div class="notice">
        Bildirimler i√ßin tarayƒ±cƒ± izin verin.
        Payla≈üƒ±m: Outlook daveti otomatik mail g√∂nderir. Diƒüerlerinde ‚ÄúPayla≈ü (ICS)‚Äù ile ki≈üiye g√∂nderip takvime ekletirsin.
      </div>

      <!-- Ekleme -->
      <div class="input-row">
        <input id="titleInp" type="text" placeholder="Konu Ba≈ülƒ±ƒüƒ±" />
        <input id="datetimeInp" type="datetime-local" />
        <select id="prioInp" aria-label="√ñncelik">
          <option value="low">√ñncelik: D√º≈ü√ºk</option>
          <option value="medium" selected>√ñncelik: Orta</option>
          <option value="high">√ñncelik: Y√ºksek</option>
        </select>
      </div>

      <textarea id="descInp" placeholder="Detaylar (opsiyonel)"></textarea>

      <!-- Payla≈üƒ±lacak ki≈üiler -->
      <div class="sub-row">
        <input id="attendeesInp" type="text" placeholder="Payla≈üƒ±lacak e-postalar (virg√ºlle): ali@x.com, ayse@y.com" />
      </div>

      <!-- Plan Olu≈ütur butonu Detay altƒ± -->
      <div class="add-row">
        <button id="addBtn" class="add-btn">Plan Olu≈ütur</button>
        <div class="hint">
          Sonra g√∂rev satƒ±rƒ±ndan: ‚ÄúPayla≈ü (ICS)‚Äù (WhatsApp/Mail) veya ‚ÄúOutlook Davet‚Äù (otomatik davet).
        </div>
      </div>

      <!-- Ara / Filtre / Sƒ±ralama -->
      <div class="toolbar">
        <input id="searchInp" type="text" placeholder="Ara (ba≈ülƒ±k veya detay‚Ä¶)" />
        <select id="statusFilter">
          <option value="all" selected>Filtre: T√ºm√º</option>
          <option value="todo">Filtre: Yapƒ±lacak</option>
          <option value="done">Filtre: Tamamlanan</option>
          <option value="overdue">Filtre: Geciken</option>
        </select>
        <select id="sortSel">
          <option value="created_desc" selected>Sƒ±rala: Yeni</option>
          <option value="deadline_asc">Sƒ±rala: Hedef Yakƒ±n</option>
          <option value="priority_desc">Sƒ±rala: √ñncelik</option>
        </select>
        <button id="clearSearch" class="ghost">Temizle</button>
      </div>

      <div id="summary" class="summary"></div>

      <ul id="list"></ul>
    </div>
  </div>

<script>
const STORAGE_KEY = 'ios_todo_v3';
const NOTIFY_THRESHOLD_MIN = 5;
const CHECK_INTERVAL_MS = 30 * 1000;
const MAX_TIMEOUT = 2147483647;

const listEl = document.getElementById('list');
const titleInp = document.getElementById('titleInp');
const descInp = document.getElementById('descInp');
const datetimeInp = document.getElementById('datetimeInp');
const prioInp = document.getElementById('prioInp');
const attendeesInp = document.getElementById('attendeesInp');
const addBtn = document.getElementById('addBtn');

const searchInp = document.getElementById('searchInp');
const statusFilter = document.getElementById('statusFilter');
const sortSel = document.getElementById('sortSel');
const clearSearchBtn = document.getElementById('clearSearch');
const summaryEl = document.getElementById('summary');

let tasks = [];
let scheduled = {};     // taskId -> timeoutId
let editingId = null;

const alarmAudio = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
alarmAudio.preload = 'auto';

// Outlook (opsiyonel)
const OUTLOOK_CLIENT_ID = "ba813c6d-7f29-4cdb-84ae-43a9bdbc7747";
const OUTLOOK_SCOPES = ["Calendars.ReadWrite"];
let msalInstance = null;
let msalAccount = null;

if (OUTLOOK_CLIENT_ID) {
  msalInstance = new msal.PublicClientApplication({
    auth: { clientId: OUTLOOK_CLIENT_ID, redirectUri: window.location.origin + window.location.pathname }
  });
  const accs = msalInstance.getAllAccounts();
  if (accs && accs.length) msalAccount = accs[0];
}

window.addEventListener('load', () => {
  loadTasks();
  requestNotificationPermission();
  refreshList();
  scheduleAll();

  setInterval(() => {
    updateOverdueUI();
    scheduleAll();
  }, CHECK_INTERVAL_MS);
});

addBtn.addEventListener('click', addTask);
titleInp.addEventListener('keydown', e => { if (e.key === 'Enter') addTask(); });
descInp.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') addTask();
});

[searchInp, statusFilter, sortSel].forEach(el => {
  el.addEventListener('input', refreshList);
  el.addEventListener('change', refreshList);
});
clearSearchBtn.addEventListener('click', () => {
  searchInp.value = '';
  statusFilter.value = 'all';
  sortSel.value = 'created_desc';
  refreshList();
});

/* ---- helpers ---- */
function isoToLocalInput(iso){
  if (!iso) return '';
  const d = new Date(iso);
  if (isNaN(d)) return '';
  const tzOffset = d.getTimezoneOffset() * 60000;
  return new Date(d.getTime() - tzOffset).toISOString().slice(0,16);
}
function localInputToISO(val){
  if (!val) return '';
  const d = new Date(val);
  if (isNaN(d)) return '';
  return d.toISOString();
}
function parseEmails(raw){
  const text = (raw || '').trim();
  if (!text) return [];
  const parts = text.split(/[,;\s]+/).map(x => x.trim()).filter(Boolean);
  const seen = new Set();
  const ok = [];
  for (const p of parts) {
    const email = p.toLowerCase();
    // basit doƒürulama
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) continue;
    if (seen.has(email)) continue;
    seen.add(email);
    ok.push(email);
    if (ok.length >= 20) break;
  }
  return ok;
}

function normalizeTask(t){
  if (!t.id) t.id = 't_' + Date.now() + '_' + Math.random().toString(36).slice(2,7);
  if (typeof t.title !== 'string') t.title = '';
  if (typeof t.desc !== 'string') t.desc = '';
  if (!t.created) t.created = new Date().toLocaleString();
  if (!t.deadline) t.deadline = '';
  if (typeof t.done !== 'boolean') t.done = false;
  if (typeof t.alerted !== 'boolean') t.alerted = false;
  if (!t.priority) t.priority = 'medium';
  if (!Array.isArray(t.attendees)) t.attendees = [];
  return t;
}

function loadTasks(){
  try {
    tasks = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    if (!Array.isArray(tasks)) tasks = [];
  } catch(e) {
    console.error('localStorage parse error', e);
    localStorage.removeItem(STORAGE_KEY);
    tasks = [];
  }
  tasks = tasks.map(normalizeTask);
  save();
}
function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
}

/* ---- add ---- */
function addTask(){
  const title = titleInp.value.trim();
  if (!title) { alert('L√ºtfen bir ba≈ülƒ±k girin!'); return; }

  const desc = descInp.value.trim();
  const deadlineISO = localInputToISO(datetimeInp.value || '');
  const created = new Date().toLocaleString();
  const attendees = parseEmails(attendeesInp.value);

  const task = normalizeTask({
    id: 't_' + Date.now() + '_' + Math.random().toString(36).slice(2,7),
    title,
    desc: desc || '',
    created,
    deadline: deadlineISO,
    done: false,
    alerted: false,
    priority: prioInp.value || 'medium',
    attendees
  });

  tasks.unshift(task);
  save();

  editingId = null;
  refreshList();
  scheduleForTask(task);

  titleInp.value = '';
  descInp.value = '';
  datetimeInp.value = '';
  prioInp.value = 'medium';
  attendeesInp.value = '';
}

/* ---- list logic ---- */
function isOverdue(task){
  if (!task.deadline) return false;
  const d = new Date(task.deadline);
  if (isNaN(d)) return false;
  return Date.now() > d.getTime();
}
function prioLabel(p){
  if (p === 'high') return 'Y√ºksek';
  if (p === 'low') return 'D√º≈ü√ºk';
  return 'Orta';
}
function prioChipClass(p){
  if (p === 'high') return 'chip prio-high';
  if (p === 'low') return 'chip prio-low';
  return 'chip prio-med';
}

function getVisibleTasks(){
  const q = (searchInp.value || '').trim().toLowerCase();
  const st = statusFilter.value;
  const sort = sortSel.value;

  let res = [...tasks];

  if (q) {
    res = res.filter(t => (t.title + ' ' + t.desc).toLowerCase().includes(q));
  }
  if (st === 'todo') res = res.filter(t => !t.done);
  if (st === 'done') res = res.filter(t => t.done);
  if (st === 'overdue') res = res.filter(t => !t.done && isOverdue(t));

  if (sort === 'created_desc') {
    res.sort((a,b) => (a.id < b.id ? 1 : -1));
  } else if (sort === 'deadline_asc') {
    res.sort((a,b) => {
      const da = a.deadline ? new Date(a.deadline).getTime() : Infinity;
      const db = b.deadline ? new Date(b.deadline).getTime() : Infinity;
      return da - db;
    });
  } else if (sort === 'priority_desc') {
    const w = { high: 3, medium: 2, low: 1 };
    res.sort((a,b) => (w[b.priority]||2) - (w[a.priority]||2));
  }
  return res;
}

function refreshList(){
  listEl.innerHTML = '';
  const visible = getVisibleTasks();
  visible.forEach(t => renderTask(t));
  updateOverdueUI();
  updateSummary();
}

function updateSummary(){
  const total = tasks.length;
  const done = tasks.filter(t => t.done).length;
  const overdue = tasks.filter(t => !t.done && isOverdue(t)).length;
  const todo = total - done;

  const q = (searchInp.value || '').trim();
  const st = statusFilter.value;
  const filterTxt = (q || st !== 'all') ? ` ‚Ä¢ G√∂r√ºnen: ${getVisibleTasks().length}` : '';
  summaryEl.textContent = `Toplam: ${total} ‚Ä¢ Yapƒ±lacak: ${todo} ‚Ä¢ Tamamlanan: ${done} ‚Ä¢ Geciken: ${overdue}${filterTxt}`;
}

/* ---- render ---- */
function renderTask(task){
  const li = document.createElement('li');
  li.dataset.id = task.id;
  if (isOverdue(task) && !task.done) li.classList.add('overdue');

  const left = document.createElement('div');
  left.className = 'li-left';

  const titleDiv = document.createElement('div');
  titleDiv.className = 'title' + (task.done ? ' done' : '');
  titleDiv.textContent = task.title;

  const prChip = document.createElement('span');
  prChip.className = prioChipClass(task.priority);
  prChip.textContent = '√ñncelik: ' + prioLabel(task.priority);
  titleDiv.appendChild(prChip);

  if (Array.isArray(task.attendees) && task.attendees.length) {
    const people = document.createElement('span');
    people.className = 'chip people';
    people.textContent = `Payla≈üƒ±m: ${task.attendees.length} ki≈üi`;
    titleDiv.appendChild(people);
  }

  left.appendChild(titleDiv);

  if (editingId !== task.id && task.desc) {
    const descDiv = document.createElement('div');
    descDiv.className = 'desc';
    descDiv.textContent = task.desc;
    left.appendChild(descDiv);
  }

  if (editingId !== task.id) {
    const metaDiv = document.createElement('div');
    metaDiv.className = 'meta';

    const createdSpan = document.createElement('span');
    createdSpan.innerHTML = `<b>Olu≈üturma:</b> ${task.created}`;
    metaDiv.appendChild(createdSpan);

    if (task.deadline) {
      const d = new Date(task.deadline);
      if (!isNaN(d)) {
        const deadlineSpan = document.createElement('span');
        deadlineSpan.innerHTML = `<b>Hedef:</b> ${d.toLocaleString()}`;
        metaDiv.appendChild(deadlineSpan);
      }
    }
    left.appendChild(metaDiv);
  }

  // Edit panel
  if (editingId === task.id) {
    const panel = document.createElement('div');
    panel.className = 'edit-panel';

    const row1 = document.createElement('div');
    row1.className = 'edit-row';

    const eTitle = document.createElement('input');
    eTitle.type = 'text';
    eTitle.value = task.title;
    eTitle.placeholder = 'Ba≈ülƒ±k';

    const eDeadline = document.createElement('input');
    eDeadline.type = 'datetime-local';
    eDeadline.value = isoToLocalInput(task.deadline);

    row1.appendChild(eTitle);
    row1.appendChild(eDeadline);

    const row2 = document.createElement('div');
    row2.className = 'edit-row';

    const ePrio = document.createElement('select');
    ePrio.innerHTML = `
      <option value="low">√ñncelik: D√º≈ü√ºk</option>
      <option value="medium">√ñncelik: Orta</option>
      <option value="high">√ñncelik: Y√ºksek</option>
    `;
    ePrio.value = task.priority || 'medium';
    row2.appendChild(ePrio);

    const eAtt = document.createElement('input');
    eAtt.type = 'text';
    eAtt.placeholder = 'Payla≈üƒ±lacak e-postalar (virg√ºlle)';
    eAtt.value = (task.attendees || []).join(', ');
    row2.appendChild(eAtt);

    const eDesc = document.createElement('textarea');
    eDesc.value = task.desc || '';
    eDesc.placeholder = 'Detaylar (opsiyonel)';

    const row3 = document.createElement('div');
    row3.className = 'edit-row';

    const saveBtn = document.createElement('button');
    saveBtn.className = 'action save';
    saveBtn.textContent = 'Kaydet';

    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'action cancel';
    cancelBtn.textContent = 'ƒ∞ptal';

    saveBtn.onclick = (e) => {
      e.stopPropagation();
      saveEdit(task.id, {
        title: eTitle.value,
        desc: eDesc.value,
        deadline: localInputToISO(eDeadline.value),
        priority: ePrio.value,
        attendees: parseEmails(eAtt.value)
      });
    };
    cancelBtn.onclick = (e) => {
      e.stopPropagation();
      editingId = null;
      refreshList();
    };

    panel.appendChild(row1);
    panel.appendChild(row2);
    panel.appendChild(eDesc);
    row3.appendChild(saveBtn);
    row3.appendChild(cancelBtn);
    panel.appendChild(row3);

    left.appendChild(panel);
  }

  const right = document.createElement('div');
  right.className = 'actions';

  if (task.alerted) {
    const badge = document.createElement('span');
    badge.className = 'alerted-badge';
    badge.textContent = 'Bildirim G√∂nderildi';
    right.appendChild(badge);
  }

  const doneBtn = document.createElement('button');
  doneBtn.className = 'action done';
  doneBtn.textContent = task.done ? 'Geri Al' : 'Tamamlandƒ±';
  doneBtn.onclick = (e) => { e.stopPropagation(); toggleDone(task.id); };
  right.appendChild(doneBtn);

  const editBtn = document.createElement('button');
  editBtn.className = 'action edit';
  editBtn.textContent = (editingId === task.id) ? 'D√ºzenleniyor' : 'D√ºzenle';
  editBtn.disabled = (editingId === task.id);
  editBtn.onclick = (e) => { e.stopPropagation(); editingId = task.id; refreshList(); };
  right.appendChild(editBtn);

  const calBtn = document.createElement('button');
  calBtn.className = 'action calendar';
  calBtn.textContent = 'Takvime Ekle';
  calBtn.onclick = async (e) => { e.stopPropagation(); await addToNativeCalendar(task); };
  right.appendChild(calBtn);

  const shareBtn = document.createElement('button');
  shareBtn.className = 'action share';
  shareBtn.textContent = 'Payla≈ü (ICS)';
  shareBtn.onclick = async (e) => { e.stopPropagation(); await shareICS(task); };
  right.appendChild(shareBtn);

  const outBtn = document.createElement('button');
  outBtn.className = 'action outlook';
  outBtn.textContent = 'Outlook Davet';
  outBtn.onclick = async (e) => {
    e.stopPropagation();
    try {
      if (!task.attendees || !task.attendees.length) {
        alert('√ñnce payla≈üƒ±lacak e-postalarƒ± gir.');
        return;
      }
      await createOutlookEvent(task, true);
      alert('Outlook daveti g√∂nderildi (katƒ±lƒ±mcƒ±lara mail gider).');
    } catch(err){
      console.error(err);
      alert('Outlook daveti g√∂nderilemedi. (Client ID / izin / oturum kontrol et)');
    }
  };
  right.appendChild(outBtn);

  const delBtn = document.createElement('button');
  delBtn.className = 'action delete';
  delBtn.textContent = 'Sil';
  delBtn.onclick = (e) => { e.stopPropagation(); deleteTask(task.id); };
  right.appendChild(delBtn);

  li.appendChild(left);
  li.appendChild(right);
  listEl.appendChild(li);
}

/* ---- edit/save/delete/done ---- */
function saveEdit(id, patch){
  const t = tasks.find(x => x.id === id);
  if (!t) return;

  const newTitle = (patch.title || '').trim();
  if (!newTitle) { alert('Ba≈ülƒ±k bo≈ü olamaz!'); return; }

  const oldDeadline = t.deadline || '';
  t.title = newTitle;
  t.desc = (patch.desc || '').trim();
  t.priority = patch.priority || 'medium';
  t.deadline = patch.deadline || '';
  t.attendees = Array.isArray(patch.attendees) ? patch.attendees : [];

  if (!t.done && (t.deadline !== oldDeadline)) t.alerted = false;

  save();
  editingId = null;
  refreshList();
  scheduleAll();
}

function deleteTask(id){
  tasks = tasks.filter(t => t.id !== id);
  save();
  if (scheduled[id]) { clearTimeout(scheduled[id]); delete scheduled[id]; }
  if (editingId === id) editingId = null;
  refreshList();
}

function toggleDone(id){
  const t = tasks.find(x => x.id === id);
  if (!t) return;

  t.done = !t.done;
  if (t.done) {
    if (scheduled[id]) { clearTimeout(scheduled[id]); delete scheduled[id]; }
    if (editingId === id) editingId = null;
  } else {
    t.alerted = false;
  }
  save();
  refreshList();
  scheduleAll();
}

function updateOverdueUI(){
  tasks.forEach(t => {
    const el = document.querySelector('li[data-id="'+t.id+'"]');
    if (!el) return;
    if (isOverdue(t) && !t.done) el.classList.add('overdue'); else el.classList.remove('overdue');
    const titleEl = el.querySelector('.title');
    if (t.done) titleEl.classList.add('done'); else titleEl.classList.remove('done');
  });
}

/* ---- notifications ---- */
async function requestNotificationPermission(){
  if (!('Notification' in window)) return;
  if (Notification.permission === 'default') {
    try { await Notification.requestPermission(); } catch(e){ console.warn(e); }
  }
}

function scheduleForTask(task){
  if (!task.deadline || task.done || task.alerted) return;

  const d = new Date(task.deadline);
  if (isNaN(d)) return;

  const now = Date.now();
  const deadlineMs = d.getTime();
  const notifyAt = deadlineMs - NOTIFY_THRESHOLD_MIN * 60 * 1000;

  let fireAt = null;
  if (notifyAt > now) fireAt = notifyAt;
  else if (deadlineMs > now) fireAt = deadlineMs;
  else return;

  const delay = fireAt - now;
  if (delay > MAX_TIMEOUT) return;

  if (scheduled[task.id]) { clearTimeout(scheduled[task.id]); delete scheduled[task.id]; }

  scheduled[task.id] = setTimeout(() => {
    const cur = tasks.find(x => x.id === task.id);
    if (!cur || cur.done || cur.alerted) { cleanupTimer(task.id); return; }

    sendAlarm(cur);
    cur.alerted = true;
    save();
    refreshList();
    cleanupTimer(task.id);
  }, delay);
}
function cleanupTimer(id){
  if (scheduled[id]) { clearTimeout(scheduled[id]); delete scheduled[id]; }
}
function scheduleAll(){
  Object.keys(scheduled).forEach(id => cleanupTimer(id));
  tasks.forEach(t => scheduleForTask(t));
}
function sendAlarm(task){
  try {
    if ('Notification' in window && Notification.permission === 'granted') {
      const body = task.title + (task.deadline ? ' ‚Ä¢ ' + (new Date(task.deadline)).toLocaleString() : '');
      const n = new Notification('G√∂rev hatƒ±rlatmasƒ±', { body, tag: task.id, renotify: false });
      n.onclick = () => window.focus();
    } else {
      alert('Hatƒ±rlatma: ' + task.title);
    }
  } catch(e){
    console.error('Notification error', e);
  }
  try { alarmAudio.currentTime = 0; alarmAudio.play().catch(()=>{}); } catch(e){}
}

window.addEventListener('storage', e => {
  if (e.key === STORAGE_KEY) {
    try { tasks = JSON.parse(e.newValue || '[]').map(normalizeTask); } catch(err){ tasks = []; }
    scheduleAll();
    refreshList();
  }
});

/* ---- ICS: add/share ---- */
function pad2(n){ return String(n).padStart(2,'0'); }
function toICSDateUTC(date){
  return date.getUTCFullYear() +
    pad2(date.getUTCMonth()+1) +
    pad2(date.getUTCDate()) + 'T' +
    pad2(date.getUTCHours()) +
    pad2(date.getUTCMinutes()) +
    pad2(date.getUTCSeconds()) + 'Z';
}
function escapeICS(text){
  return String(text || '')
    .replace(/\\/g, '\\\\')
    .replace(/\n/g, '\\n')
    .replace(/,/g, '\\,')
    .replace(/;/g, '\\;');
}
function buildICS(task){
  const now = new Date();
  const uid = (task.id || ('t_'+Date.now())) + '@gorev-planlayici';

  const start = task.deadline ? new Date(task.deadline) : new Date();
  const end = new Date(start.getTime() + 30*60000);

  const dtstamp = toICSDateUTC(now);
  const dtstart = toICSDateUTC(start);
  const dtend = toICSDateUTC(end);

  const summary = escapeICS(task.title || 'Plan');
  const desc = escapeICS(task.desc || '');

  // Not: ATTENDEE satƒ±rlarƒ± importta her zaman ‚Äúdavet‚Äù gibi √ßalƒ±≈ümaz,
  // o y√ºzden √ßok g√ºvenmeyip ‚ÄúPayla≈ü (ICS)‚Äù + Outlook Davet sunduk.
  const attendeesLines = (task.attendees || []).map(e => `ATTENDEE;CN=${e}:mailto:${e}`);

  return [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//GorevPlanlayici//TR',
    'CALSCALE:GREGORIAN',
    'METHOD:PUBLISH',
    'BEGIN:VEVENT',
    'UID:' + uid,
    'DTSTAMP:' + dtstamp,
    'DTSTART:' + dtstart,
    'DTEND:' + dtend,
    'SUMMARY:' + summary,
    desc ? ('DESCRIPTION:' + desc) : '',
    ...attendeesLines,
    'END:VEVENT',
    'END:VCALENDAR'
  ].filter(Boolean).join('\r\n');
}

function makeICSBlob(task){
  const ics = buildICS(task);
  const filename = (task.title || 'plan').replace(/[^\w\-]+/g,'_').slice(0,40) + '.ics';
  const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
  return { blob, filename };
}

async function addToNativeCalendar(task){
  // ‚ÄúTakvime ekle‚Äù = dosyayƒ± a√ßtƒ±rma
  const { blob, filename } = makeICSBlob(task);

  // share sheet varsa direkt a√ßtƒ±r
  try {
    const file = new File([blob], filename, { type: 'text/calendar' });
    if (navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share) {
      await navigator.share({ files: [file], title: task.title || 'Plan', text: 'Takvime eklemek i√ßin a√ß.' });
      return;
    }
  } catch(e){}

  // fallback: indir
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 2000);
  alert('ICS indirildi. Dosyayƒ± a√ßƒ±p Takvim‚Äôe ekleyebilirsin.');
}

async function shareICS(task){
  const { blob, filename } = makeICSBlob(task);

  const people = (task.attendees || []).join(', ');
  const text = people
    ? `Plan payla≈üƒ±mƒ±: ${people}\n\nDosyayƒ± a√ßƒ±p Takvim'e ekleyin.`
    : `Dosyayƒ± a√ßƒ±p Takvim'e ekleyin.`;

  try {
    const file = new File([blob], filename, { type: 'text/calendar' });
    if (navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share) {
      await navigator.share({ files: [file], title: task.title || 'Plan', text });
      return;
    }
  } catch(e){}

  // Share yoksa indirme
  await addToNativeCalendar(task);
}

/* ---- Outlook invite ---- */
async function ensureMsalLogin(){
  if (!msalInstance) throw new Error('Outlook entegrasyonu devre dƒ±≈üƒ±.');
  if (!msalAccount) {
    const resp = await msalInstance.loginPopup({ scopes: OUTLOOK_SCOPES });
    msalAccount = resp.account;
  }
  return msalAccount;
}
async function getAccessToken(){
  if (!msalInstance) throw new Error('Outlook entegrasyonu devre dƒ±≈üƒ±.');
  const req = { scopes: OUTLOOK_SCOPES, account: msalAccount };
  try {
    const resp = await msalInstance.acquireTokenSilent(req);
    return resp.accessToken;
  } catch(e){
    const resp = await msalInstance.acquireTokenPopup(req);
    return resp.accessToken;
  }
}

async function createOutlookEvent(task, withAttendees){
  if (!task) throw new Error('Task bulunamadƒ±');
  await ensureMsalLogin();
  const token = await getAccessToken();

  const start = task.deadline ? new Date(task.deadline) : new Date();
  const end = new Date(start.getTime() + 30*60000);
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';

  const event = {
    subject: task.title,
    body: { contentType: 'Text', content: task.desc || '' },
    start: { dateTime: start.toISOString(), timeZone: tz },
    end: { dateTime: end.toISOString(), timeZone: tz }
  };

  if (withAttendees && task.attendees && task.attendees.length) {
    event.attendees = task.attendees.map(email => ({
      emailAddress: { address: email },
      type: "required"
    }));
  }

  const resp = await fetch('https://graph.microsoft.com/v1.0/me/events', {
    method: 'POST',
    headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
    body: JSON.stringify(event)
  });

  if (!resp.ok) throw new Error('Graph API error: ' + resp.status + ' ' + await resp.text());
  return resp.json();
}

window.debug_clearAll = function(){
  localStorage.removeItem(STORAGE_KEY);
  tasks = [];
  editingId = null;
  refreshList();
};
</script>
</body>
</html>
