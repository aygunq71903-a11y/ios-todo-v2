<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>G√∂rev Planlayƒ±cƒ± (G√ºncel)</title>

  <style>
    :root{
      --primary:#007AFF;
      --bg:#F2F2F7;
      --card:#FFFFFF;
      --text:#1C1C1E;
      --muted:#8E8E93;
      --danger:#FF3B30;
      --ok:#16A34A;
      --border:#D1D1D6;
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;color:var(--text)}
    .wrap{max-width:720px;margin:28px auto;padding:18px}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
    h1{margin:0 0 12px 0;font-size:20px}
    .notice{font-size:13px;color:var(--muted);margin-bottom:10px}

    .input-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
    input,textarea,button,select{font-size:15px;padding:10px;border-radius:8px;border:1px solid var(--border);background:#fff}
    input#titleInp{width:220px;flex:0 0 auto}
    input[type="datetime-local"]{min-width:220px}
    textarea{width:100%;min-height:70px;resize:vertical}

    .sub-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center}
    .sub-row input{flex:0 0 auto}

    #attendeesInp{
      max-width:360px;
      width:360px;
    }

    .icon-btn{
      width:44px;height:44px;
      padding:0;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-size:22px;
      line-height:44px;
      text-align:center;
      color:#1c1c1e;
    }

    .add-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center}
    .add-btn{background:var(--primary);color:#fff;border:none;cursor:pointer;padding:10px 14px}
    .hint{font-size:13px;color:var(--muted)}

    /* Ara / filtre / sƒ±ralama */
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;align-items:center}
    .toolbar input[type="text"]{flex:1 1 auto; min-width:220px;}
    .toolbar select{min-width:160px}
    .ghost{background:#fff;border:1px solid var(--border);cursor:pointer}
    .summary{margin-top:10px;font-size:13px;color:var(--muted)}

    ul{list-style:none;padding:0;margin:12px 0 0 0}
    li{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;padding:12px;border-radius:8px;background:#fff;border:1px solid #eee;margin-bottom:10px;transition:all .15s}
    .li-left{flex:1}
    .title{font-weight:700;margin-bottom:6px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .title.done{color:var(--ok);text-decoration:none}
    .desc{color:#333;margin-bottom:8px;white-space:pre-wrap}
    .meta{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}

    .chip{
      font-size:12px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #e5e5ea;
      background:#fafafa;
      color:#333;
    }
    .chip.prio-high{border-color:#ffd5d2;background:#fff6f6}
    .chip.prio-med{border-color:#e5e5ea;background:#fafafa}
    .chip.prio-low{border-color:#d6eaff;background:#f4f9ff}
    .chip.people{border-color:#d7f0e0;background:#f4fff8;color:#0f6b36}

    .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button.action{padding:6px 10px;border-radius:6px;border:none;cursor:pointer}
    button.delete{background:#FFF0F0;color:var(--danger)}
    button.done{background:#E8F8EE;color:var(--ok)}
    button.edit{background:#fff8e6;color:#9a6700;border:1px solid #ffe0a3}
    button.save{background:#e9f7ff;color:#0b63d1;border:1px solid #cfe8ff}
    button.cancel{background:#f2f2f7;color:#444;border:1px solid #e5e5ea}
    button.calendar{background:#f5f0ff;color:#5b2bd6;border:1px solid #e6dbff}
    button.share{background:#eafff7;color:#0f6b36;border:1px solid #c9f2df}
    button.outlook{background:#eef6ff;color:var(--primary);border:1px solid #d6eaff}

    .overdue{border-left:6px solid var(--danger)}

    .edit-panel{
      margin-top:10px;
      padding:10px;
      border:1px dashed #e5e5ea;
      border-radius:10px;
      background:#fbfbfd;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .edit-row{display:flex;gap:8px;flex-wrap:wrap}
    .edit-row input[type="text"]{flex:1 1 220px}
    .edit-row input[type="datetime-local"]{min-width:220px}

    .toolbar input, .toolbar select, .toolbar button{
      padding: 8px;
      font-size: 14px;
    }

    /* Modal (Ki≈üi se√ßici) */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal.hidden{display:none}
    .modal-card{
      width:min(680px, 100%);
      background:#fff;
      border-radius:14px;
      box-shadow:0 12px 40px rgba(0,0,0,.18);
      overflow:hidden;
      border:1px solid #eee;
    }
    .modal-head{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid #eee;
      background:#fafafa;
    }
    .modal-head strong{font-size:15px}
    .modal-body{padding:12px 14px}
    .modal-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .modal-row input{flex:1 1 220px}
    .modal-actions{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 10px;border-radius:10px;border:1px solid #e5e5ea;background:#fff;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .contacts{
      margin-top:10px;
      max-height:320px;
      overflow:auto;
      border:1px solid #eee;
      border-radius:12px;
    }
    .contact-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid #f0f0f0;
    }
    .contact-item:last-child{border-bottom:none}
    .contact-name{font-weight:600}
    .contact-mail{font-size:12px;color:var(--muted)}
    .contact-left{display:flex;flex-direction:column;gap:2px}
    .pill{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid #e5e5ea;
      background:#fff;
      cursor:pointer;
    }
    .pill.add{border-color:#c9f2df;background:#f4fff8;color:#0f6b36}
    .pill.added{border-color:#d6eaff;background:#f4f9ff;color:#0b63d1;cursor:default}

    @media (max-width:600px){
      input#titleInp{width:100%}
      .input-row{flex-direction:column;align-items:stretch}
      input[type="datetime-local"]{width:100%}
      .sub-row{flex-direction:column;align-items:stretch}
      #attendeesInp{max-width:100%;width:100%}
      .add-row{flex-direction:column;align-items:stretch}
      .toolbar{flex-direction:column;align-items:stretch}
      .toolbar select{width:100%}
      .toolbar input, .toolbar select, .toolbar button{
        padding: 7px;
        font-size: 13px;
      }

      /* Mobilde arama alanƒ± k√º√ß√ºk */
      .toolbar input[type="text"]{
        flex: 0 0 auto;
        height: 44px;
        padding: 8px 10px;
        min-width: 0;
      }

      .icon-btn{width:100%; height:44px; font-size:16px}
      .edit-row{flex-direction:column}
      .edit-row input[type="datetime-local"]{width:100%}
      .contacts{max-height:55vh}
    }
  </style>

  <!-- MSAL for Outlook -->
  <script src="https://alcdn.msauth.net/browser/2.28.1/js/msal-browser.min.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>üìù G√∂rev Planlayƒ±cƒ±</h1>
      <div class="notice">
        Bildirimler: 10 dk kala ve hedef saat ge√ßtikten 1 sn sonra √ßalar (kartal sesi 5 defa).
      </div>

      <div class="input-row">
        <input id="titleInp" type="text" placeholder="Konu Ba≈ülƒ±ƒüƒ±" />
        <input id="datetimeInp" type="datetime-local" />
        <select id="prioInp" aria-label="√ñncelik">
          <option value="low">√ñncelik: D√º≈ü√ºk</option>
          <option value="medium" selected>√ñncelik: Orta</option>
          <option value="high">√ñncelik: Y√ºksek</option>
        </select>
      </div>

      <textarea id="descInp" placeholder="Detaylar (opsiyonel)"></textarea>

      <div class="sub-row">
        <input id="attendeesInp" type="text" placeholder="Davet e-postalarƒ± (virg√ºlle): ali@x.com, ayse@y.com" />
        <button id="pickContactBtn" class="icon-btn" title="Ki≈üi se√ß">+</button>
      </div>

      <div class="add-row">
        <button id="addBtn" class="add-btn">Plan Olu≈ütur</button>
        <div class="hint">G√∂rev satƒ±rƒ±ndan: ‚ÄúPayla≈ü (ICS)‚Äù veya ‚ÄúOutlook‚Äôa Ekle‚Äù.</div>
      </div>

      <div class="toolbar">
        <input id="searchInp" type="text" placeholder="Ara (ba≈ülƒ±k ve detay‚Ä¶)" />
        <select id="statusFilter">
          <option value="all" selected>Filtre: T√ºm√º</option>
          <option value="todo">Filtre: Yapƒ±lacak</option>
          <option value="done">Filtre: Tamamlanan</option>
          <option value="overdue">Filtre: Geciken</option>
        </select>
        <select id="sortSel">
          <option value="created_desc" selected>Sƒ±rala: Yeni</option>
          <option value="deadline_asc">Sƒ±rala: Hedef Yakƒ±n</option>
          <option value="priority_desc">Sƒ±rala: √ñncelik</option>
        </select>
        <button id="clearSearch" class="ghost">Temizle</button>
      </div>

      <div id="summary" class="summary"></div>
      <ul id="list"></ul>
    </div>
  </div>

  <!-- Ki≈üi Se√ßici Modal -->
  <div id="contactModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-head">
        <strong>üìá Ki≈üi Se√ß</strong>
        <div class="modal-actions">
          <button id="contactCloseBtn" class="btn">Kapat</button>
          <button id="contactDoneBtn" class="btn primary">Ekle</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="modal-row">
          <input id="contactSearchInp" type="text" placeholder="Ara: isim veya e-posta" />
          <button id="contactSearchBtn" class="btn">Ara</button>
          <button id="contactRefreshBtn" class="btn">Yenile</button>
        </div>
        <div id="contactInfo" class="notice" style="margin-top:10px"></div>
        <div id="contactsList" class="contacts"></div>
      </div>
    </div>
  </div>

<script>
const STORAGE_KEY = 'ios_todo_v3';

// 10 dk kala + hedef saat ge√ßtikten 1 sn sonra
const NOTIFY_BEFORE_MIN = 10;
const LATE_AFTER_MS = 1000;

const CHECK_INTERVAL_MS = 30 * 1000;
const MAX_TIMEOUT = 2147483647;

const listEl = document.getElementById('list');
const titleInp = document.getElementById('titleInp');
const descInp = document.getElementById('descInp');
const datetimeInp = document.getElementById('datetimeInp');
const prioInp = document.getElementById('prioInp');
const attendeesInp = document.getElementById('attendeesInp');
const addBtn = document.getElementById('addBtn');

const pickContactBtn = document.getElementById('pickContactBtn');
const contactModal = document.getElementById('contactModal');
const contactCloseBtn = document.getElementById('contactCloseBtn');
const contactDoneBtn = document.getElementById('contactDoneBtn');
const contactSearchInp = document.getElementById('contactSearchInp');
const contactSearchBtn = document.getElementById('contactSearchBtn');
const contactRefreshBtn = document.getElementById('contactRefreshBtn');
const contactsList = document.getElementById('contactsList');
const contactInfo = document.getElementById('contactInfo');

const searchInp = document.getElementById('searchInp');
const statusFilter = document.getElementById('statusFilter');
const sortSel = document.getElementById('sortSel');
const clearSearchBtn = document.getElementById('clearSearch');
const summaryEl = document.getElementById('summary');

let tasks = [];
let scheduled = {};
let editingId = null;

// Kartal sesi 5 defa
const eagleAudio = new Audio('https://upload.wikimedia.org/wikipedia/commons/5/59/Bald_Eagle_Yellowstone_National_Park.ogg');
eagleAudio.preload = 'auto';

// fallback alarm
const alarmAudio = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
alarmAudio.preload = 'auto';

function playAudioNTimes(audio, times){
  let count = 0;
  const playOnce = () => {
    count++;
    try {
      audio.currentTime = 0;
      const p = audio.play();
      if (p && typeof p.then === 'function') p.catch(() => {});
    } catch(e){}

    audio.onended = () => {
      audio.onended = null;
      if (count < times) setTimeout(playOnce, 150);
    };

    setTimeout(() => {
      if (count < times && audio.onended) {
        audio.onended = null;
        playOnce();
      }
    }, 4000);
  };
  playOnce();
}

/* =========================
   Outlook / Microsoft Graph
   =========================
   Not: Ki≈üi listesi i√ßin People.Read gerekir.
*/
const OUTLOOK_CLIENT_ID = "ba813c6d-7f29-4cdb-84ae-43a9bdbc7747";
const OUTLOOK_SCOPES = ["User.Read", "Calendars.ReadWrite", "People.Read"]; // Contacts i√ßin gerekli

let msalInstance = null;
let msalAccount = null;

if (OUTLOOK_CLIENT_ID) {
  msalInstance = new msal.PublicClientApplication({
    auth: { clientId: OUTLOOK_CLIENT_ID, redirectUri: window.location.origin + window.location.pathname }
  });
  const accs = msalInstance.getAllAccounts();
  if (accs && accs.length) msalAccount = accs[0];
}

async function ensureMsalLogin(){
  if (!msalInstance) throw new Error('Outlook entegrasyonu devre dƒ±≈üƒ±.');
  if (!msalAccount) {
    const resp = await msalInstance.loginPopup({ scopes: OUTLOOK_SCOPES });
    msalAccount = resp.account;
  }
  return msalAccount;
}

async function getAccessToken(){
  if (!msalInstance) throw new Error('Outlook entegrasyonu devre dƒ±≈üƒ±.');
  const req = { scopes: OUTLOOK_SCOPES, account: msalAccount };
  try {
    const resp = await msalInstance.acquireTokenSilent(req);
    return resp.accessToken;
  } catch(e){
    const resp = await msalInstance.acquireTokenPopup(req);
    return resp.accessToken;
  }
}

/* Ki≈üiler (Microsoft) */
let cachedPeople = [];             // {name,email}
let selectedPeopleEmails = new Set();

function peopleToSimple(items){
  const out = [];
  for (const it of items || []) {
    const name = it.displayName || it.givenName || it.surname || it.userPrincipalName || 'Ki≈üi';
    const emails = [];
    if (Array.isArray(it.scoredEmailAddresses)) {
      for (const se of it.scoredEmailAddresses) if (se && se.address) emails.push(se.address);
    }
    if (it.emailAddresses && Array.isArray(it.emailAddresses)) {
      for (const e of it.emailAddresses) if (e && e.address) emails.push(e.address);
    }
    if (it.userPrincipalName) emails.push(it.userPrincipalName);

    const email = (emails.find(x => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(x).toLowerCase())) || '').toLowerCase();
    if (email) out.push({ name, email });
  }
  // uniq by email
  const seen = new Set();
  return out.filter(p => !seen.has(p.email) && seen.add(p.email));
}

async function fetchPeople(searchText){
  await ensureMsalLogin();
  const token = await getAccessToken();

  const hasQuery = !!(searchText || '').trim();
  const q = (searchText || '').trim().replace(/"/g, '\\"');

  const url = hasQuery
    ? `https://graph.microsoft.com/v1.0/me/people?$search="${encodeURIComponent(q)}"&$top=30`
    : `https://graph.microsoft.com/v1.0/me/people?$top=50`;

  const headers = {
    Authorization: 'Bearer ' + token
  };

  // $search i√ßin bu header ≈üart
  if (hasQuery) headers['ConsistencyLevel'] = 'eventual';

  const resp = await fetch(url, { headers });
  if (!resp.ok) throw new Error('Ki≈üiler alƒ±namadƒ±: ' + resp.status + ' ' + await resp.text());
  const data = await resp.json();
  const simple = peopleToSimple(data.value || []);
  return simple;
}

function openContactsModal(){
  contactModal.classList.remove('hidden');
  contactSearchInp.value = '';
  contactInfo.textContent = 'Ki≈üiler y√ºkleniyor... (Microsoft hesabƒ±n ile giri≈ü ister)';
  contactsList.innerHTML = '';
  selectedPeopleEmails = new Set(parseEmails(attendeesInp.value));
  loadContacts('');
}

function closeContactsModal(){
  contactModal.classList.add('hidden');
}

async function loadContacts(query){
  try {
    const people = await fetchPeople(query);
    if (!query) cachedPeople = people;
    renderContacts(people);
    contactInfo.textContent = people.length ? 'Ki≈üi se√ßip ‚ÄúEkle‚Äùye bas.' : 'Ki≈üi bulunamadƒ±. Aramayƒ± deƒüi≈ütir veya manuel yaz.';
  } catch(err){
    console.error(err);
    contactInfo.textContent =
      'Ki≈üiler √ßekilemedi. (ƒ∞zin/hesap t√ºr√º olabilir) Yine de maili manuel yazabilirsin.';
    renderContacts([]);
  }
}

function renderContacts(people){
  contactsList.innerHTML = '';
  const list = people || [];

  if (!list.length) {
    const empty = document.createElement('div');
    empty.style.padding = '12px';
    empty.style.color = '#666';
    empty.textContent = 'Liste bo≈ü.';
    contactsList.appendChild(empty);
    return;
  }

  for (const p of list) {
    const row = document.createElement('div');
    row.className = 'contact-item';

    const left = document.createElement('div');
    left.className = 'contact-left';

    const nm = document.createElement('div');
    nm.className = 'contact-name';
    nm.textContent = p.name;

    const em = document.createElement('div');
    em.className = 'contact-mail';
    em.textContent = p.email;

    left.appendChild(nm);
    left.appendChild(em);

    const btn = document.createElement('button');
    const already = selectedPeopleEmails.has(p.email);
    btn.className = 'pill ' + (already ? 'added' : 'add');
    btn.textContent = already ? 'Eklendi' : 'Ekle';
    btn.disabled = already;

    btn.onclick = () => {
      selectedPeopleEmails.add(p.email);
      btn.className = 'pill added';
      btn.textContent = 'Eklendi';
      btn.disabled = true;
    };

    row.appendChild(left);
    row.appendChild(btn);
    contactsList.appendChild(row);
  }
}

pickContactBtn.addEventListener('click', openContactsModal);
contactCloseBtn.addEventListener('click', closeContactsModal);
contactDoneBtn.addEventListener('click', () => {
  const merged = new Set(parseEmails(attendeesInp.value));
  for (const e of selectedPeopleEmails) merged.add(e);
  attendeesInp.value = Array.from(merged).join(', ');
  closeContactsModal();
});
contactSearchBtn.addEventListener('click', () => loadContacts(contactSearchInp.value));
contactRefreshBtn.addEventListener('click', () => loadContacts(contactSearchInp.value));
contactSearchInp.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') loadContacts(contactSearchInp.value);
});
contactModal.addEventListener('click', (e) => {
  if (e.target === contactModal) closeContactsModal();
});

/* =========================
   App core
   ========================= */
window.addEventListener('load', () => {
  loadTasks();
  requestNotificationPermission();
  setDefaultDateTime();
  refreshList();
  scheduleAll();

  setInterval(() => {
    updateOverdueUI();
    scheduleAll();
  }, CHECK_INTERVAL_MS);
});

addBtn.addEventListener('click', addTask);
titleInp.addEventListener('keydown', e => { if (e.key === 'Enter') addTask(); });
descInp.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') addTask();
});

[searchInp, statusFilter, sortSel].forEach(el => {
  el.addEventListener('input', refreshList);
  el.addEventListener('change', refreshList);
});
clearSearchBtn.addEventListener('click', () => {
  searchInp.value = '';
  statusFilter.value = 'all';
  sortSel.value = 'created_desc';
  refreshList();
});

/* helpers */
function isoToLocalInput(iso){
  if (!iso) return '';
  const d = new Date(iso);
  if (isNaN(d)) return '';
  const tzOffset = d.getTimezoneOffset() * 60000;
  return new Date(d.getTime() - tzOffset).toISOString().slice(0,16);
}
function localInputToISO(val){
  if (!val) return '';
  const d = new Date(val);
  if (isNaN(d)) return '';
  return d.toISOString();
}
function setDefaultDateTime(){
  const d = new Date();
  d.setMinutes(d.getMinutes() + 30);
  d.setSeconds(0,0);
  datetimeInp.value = isoToLocalInput(d.toISOString());
}
function parseEmails(raw){
  const text = (raw || '').trim();
  if (!text) return [];
  const parts = text.split(/[,;\s]+/).map(x => x.trim()).filter(Boolean);
  const seen = new Set();
  const ok = [];
  for (const p of parts) {
    const email = p.toLowerCase();
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) continue;
    if (seen.has(email)) continue;
    seen.add(email);
    ok.push(email);
    if (ok.length >= 20) break;
  }
  return ok;
}

function normalizeTask(t){
  if (!t.id) t.id = 't_' + Date.now() + '_' + Math.random().toString(36).slice(2,7);
  if (typeof t.title !== 'string') t.title = '';
  if (typeof t.desc !== 'string') t.desc = '';
  if (!t.created) t.created = new Date().toLocaleString();
  if (!t.deadline) t.deadline = '';
  if (typeof t.done !== 'boolean') t.done = false;

  const legacyAlerted = !!t.alerted;
  if (typeof t.alertedBefore !== 'boolean') t.alertedBefore = legacyAlerted;
  if (typeof t.alertedLate !== 'boolean') t.alertedLate = legacyAlerted;

  if (!t.priority) t.priority = 'medium';
  if (!Array.isArray(t.attendees)) t.attendees = [];
  return t;
}

function loadTasks(){
  try {
    tasks = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    if (!Array.isArray(tasks)) tasks = [];
  } catch(e) {
    console.error('localStorage parse error', e);
    localStorage.removeItem(STORAGE_KEY);
    tasks = [];
  }
  tasks = tasks.map(normalizeTask);
  save();
}
function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
}

/* add */
function addTask(){
  const title = titleInp.value.trim();
  if (!title) { alert('L√ºtfen bir ba≈ülƒ±k girin!'); return; }

  const desc = descInp.value.trim();
  const deadlineISO = localInputToISO(datetimeInp.value || '');
  const created = new Date().toLocaleString();
  const attendees = parseEmails(attendeesInp.value);

  const task = normalizeTask({
    id: 't_' + Date.now() + '_' + Math.random().toString(36).slice(2,7),
    title,
    desc: desc || '',
    created,
    deadline: deadlineISO,
    done: false,
    alertedBefore: false,
    alertedLate: false,
    priority: prioInp.value || 'medium',
    attendees
  });

  tasks.unshift(task);
  save();

  editingId = null;
  refreshList();
  scheduleForTask(task);

  titleInp.value = '';
  descInp.value = '';
  setDefaultDateTime();
  prioInp.value = 'medium';
  attendeesInp.value = '';
}

/* list logic */
function isOverdue(task){
  if (!task.deadline) return false;
  const d = new Date(task.deadline);
  if (isNaN(d)) return false;
  return Date.now() > d.getTime();
}
function prioLabel(p){
  if (p === 'high') return 'Y√ºksek';
  if (p === 'low') return 'D√º≈ü√ºk';
  return 'Orta';
}
function prioChipClass(p){
  if (p === 'high') return 'chip prio-high';
  if (p === 'low') return 'chip prio-low';
  return 'chip prio-med';
}

function getVisibleTasks(){
  const q = (searchInp.value || '').trim().toLowerCase();
  const st = statusFilter.value;
  const sort = sortSel.value;

  let res = [...tasks];

  if (q) res = res.filter(t => (t.title + ' ' + t.desc).toLowerCase().includes(q));
  if (st === 'todo') res = res.filter(t => !t.done);
  if (st === 'done') res = res.filter(t => t.done);
  if (st === 'overdue') res = res.filter(t => !t.done && isOverdue(t));

  if (sort === 'created_desc') {
    res.sort((a,b) => (a.id < b.id ? 1 : -1));
  } else if (sort === 'deadline_asc') {
    res.sort((a,b) => {
      const da = a.deadline ? new Date(a.deadline).getTime() : Infinity;
      const db = b.deadline ? new Date(b.deadline).getTime() : Infinity;
      return da - db;
    });
  } else if (sort === 'priority_desc') {
    const w = { high: 3, medium: 2, low: 1 };
    res.sort((a,b) => (w[b.priority]||2) - (w[a.priority]||2));
  }
  return res;
}

function refreshList(){
  listEl.innerHTML = '';
  const visible = getVisibleTasks();
  visible.forEach(t => renderTask(t));
  updateOverdueUI();
  updateSummary();
}

function updateSummary(){
  const total = tasks.length;
  const done = tasks.filter(t => t.done).length;
  const overdue = tasks.filter(t => !t.done && isOverdue(t)).length;
  const todo = total - done;

  const q = (searchInp.value || '').trim();
  const st = statusFilter.value;
  const filterTxt = (q || st !== 'all') ? ` ‚Ä¢ G√∂r√ºnen: ${getVisibleTasks().length}` : '';
  summaryEl.textContent = `Toplam: ${total} ‚Ä¢ Yapƒ±lacak: ${todo} ‚Ä¢ Tamamlanan: ${done} ‚Ä¢ Geciken: ${overdue}${filterTxt}`;
}

/* render */
function renderTask(task){
  const li = document.createElement('li');
  li.dataset.id = task.id;
  if (isOverdue(task) && !task.done) li.classList.add('overdue');

  const left = document.createElement('div');
  left.className = 'li-left';

  const titleDiv = document.createElement('div');
  titleDiv.className = 'title' + (task.done ? ' done' : '');
  titleDiv.textContent = task.title;

  const prChip = document.createElement('span');
  prChip.className = prioChipClass(task.priority);
  prChip.textContent = '√ñncelik: ' + prioLabel(task.priority);
  titleDiv.appendChild(prChip);

  if (Array.isArray(task.attendees) && task.attendees.length) {
    const people = document.createElement('span');
    people.className = 'chip people';
    people.textContent = `Davet: ${task.attendees.length} ki≈üi`;
    titleDiv.appendChild(people);
  }

  left.appendChild(titleDiv);

  if (editingId !== task.id && task.desc) {
    const descDiv = document.createElement('div');
    descDiv.className = 'desc';
    descDiv.textContent = task.desc;
    left.appendChild(descDiv);
  }

  if (editingId !== task.id) {
    const metaDiv = document.createElement('div');
    metaDiv.className = 'meta';

    const createdSpan = document.createElement('span');
    createdSpan.innerHTML = `<b>Olu≈üturma:</b> ${task.created}`;
    metaDiv.appendChild(createdSpan);

    if (task.deadline) {
      const d = new Date(task.deadline);
      if (!isNaN(d)) {
        const deadlineSpan = document.createElement('span');
        deadlineSpan.innerHTML = `<b>Hedef:</b> ${d.toLocaleString()}`;
        metaDiv.appendChild(deadlineSpan);
      }
    }
    left.appendChild(metaDiv);
  }

  const right = document.createElement('div');
  right.className = 'actions';

  const doneBtn = document.createElement('button');
  doneBtn.className = 'action done';
  doneBtn.textContent = task.done ? 'Geri Al' : 'Tamamlandƒ±';
  doneBtn.onclick = (e) => { e.stopPropagation(); toggleDone(task.id); };
  right.appendChild(doneBtn);

  const calBtn = document.createElement('button');
  calBtn.className = 'action calendar';
  calBtn.textContent = 'Takvime Ekle';
  calBtn.onclick = async (e) => { e.stopPropagation(); await addToNativeCalendar(task); };
  right.appendChild(calBtn);

  const shareBtn = document.createElement('button');
  shareBtn.className = 'action share';
  shareBtn.textContent = 'Payla≈ü (ICS)';
  shareBtn.onclick = async (e) => { e.stopPropagation(); await shareICS(task); };
  right.appendChild(shareBtn);

  // ‚úÖ OUTLOOK: mail yazmasa da kendi takvimine ekler
  // ‚úÖ mail yazdƒ±ysa attendees ekler ve Outlook davet yollar
  const outBtn = document.createElement('button');
  outBtn.className = 'action outlook';
  outBtn.textContent = "Outlook'a Ekle";
  outBtn.onclick = async (e) => {
    e.stopPropagation();
    try {
      const hasAtt = Array.isArray(task.attendees) && task.attendees.length > 0;
      await createOutlookEvent(task, hasAtt);
      alert(hasAtt ? 'Outlook takvimine eklendi ve davet g√∂nderildi.' : 'Outlook takvimine eklendi.');
    } catch(err){
      console.error(err);
      alert("Outlook eklenemedi. (Client ID / izin / oturum kontrol et)");
    }
  };
  right.appendChild(outBtn);

  const delBtn = document.createElement('button');
  delBtn.className = 'action delete';
  delBtn.textContent = 'Sil';
  delBtn.onclick = (e) => { e.stopPropagation(); deleteTask(task.id); };
  right.appendChild(delBtn);

  li.appendChild(left);
  li.appendChild(right);
  listEl.appendChild(li);
}

/* delete/done */
function deleteTask(id){
  tasks = tasks.filter(t => t.id !== id);
  save();
  clearTimersForTask(id);
  refreshList();
}

function toggleDone(id){
  const t = tasks.find(x => x.id === id);
  if (!t) return;

  t.done = !t.done;

  if (t.done) {
    clearTimersForTask(id);
  } else {
    t.alertedBefore = false;
    t.alertedLate = false;
  }

  save();
  refreshList();
  scheduleAll();
}

function updateOverdueUI(){
  tasks.forEach(t => {
    const el = document.querySelector('li[data-id="'+t.id+'"]');
    if (!el) return;
    if (isOverdue(t) && !t.done) el.classList.add('overdue'); else el.classList.remove('overdue');
    const titleEl = el.querySelector('.title');
    if (t.done) titleEl.classList.add('done'); else titleEl.classList.remove('done');
  });
}

/* Notifications */
async function requestNotificationPermission(){
  if (!('Notification' in window)) return;
  if (Notification.permission === 'default') {
    try { await Notification.requestPermission(); } catch(e){ console.warn(e); }
  }
}

function clearTimersForTask(id){
  Object.keys(scheduled).forEach(k => {
    if (k.startsWith(id + '_')) {
      clearTimeout(scheduled[k]);
      delete scheduled[k];
    }
  });
}

function scheduleForTask(task){
  if (!task.deadline || task.done) return;

  const d = new Date(task.deadline);
  if (isNaN(d)) return;

  const now = Date.now();
  const deadlineMs = d.getTime();

  const beforeAt = deadlineMs - NOTIFY_BEFORE_MIN * 60 * 1000;
  const lateAt = deadlineMs + LATE_AFTER_MS;

  if (!task.alertedBefore && beforeAt > now) scheduleOne(task, beforeAt, 'before');
  if (!task.alertedLate && lateAt > now) scheduleOne(task, lateAt, 'late');
}

function scheduleOne(task, fireAt, kind){
  const delay = fireAt - Date.now();
  if (delay <= 0 || delay > MAX_TIMEOUT) return;

  const key = task.id + '_' + kind;
  if (scheduled[key]) return;

  scheduled[key] = setTimeout(() => {
    const cur = tasks.find(x => x.id === task.id);
    if (!cur || cur.done) {
      clearTimeout(scheduled[key]);
      delete scheduled[key];
      return;
    }

    if (kind === 'before' && cur.alertedBefore) return;
    if (kind === 'late' && cur.alertedLate) return;

    sendAlarm(cur, kind);

    if (kind === 'before') cur.alertedBefore = true;
    if (kind === 'late') cur.alertedLate = true;

    save();

    clearTimeout(scheduled[key]);
    delete scheduled[key];
  }, delay);
}

function scheduleAll(){
  Object.keys(scheduled).forEach(k => { clearTimeout(scheduled[k]); delete scheduled[k]; });
  tasks.forEach(t => scheduleForTask(t));
}

function sendAlarm(task, kind){
  try {
    if ('Notification' in window && Notification.permission === 'granted') {
      const whenText =
        kind === 'before'
          ? `10 dk kaldƒ± ‚Ä¢ ${new Date(task.deadline).toLocaleString()}`
          : `Gecikti (1 sn) ‚Ä¢ ${new Date(task.deadline).toLocaleString()}`;

      const n = new Notification('G√∂rev hatƒ±rlatmasƒ±', {
        body: `${task.title} ‚Ä¢ ${whenText}`,
        tag: task.id + '_' + kind,
        renotify: false
      });
      n.onclick = () => window.focus();
    } else {
      alert((kind === 'before' ? '10 dk kaldƒ±: ' : 'Gecikti: ') + task.title);
    }
  } catch(e){
    console.error('Notification error', e);
  }

  try {
    playAudioNTimes(eagleAudio, 5);
  } catch(e) {
    try { alarmAudio.currentTime = 0; alarmAudio.play().catch(()=>{}); } catch(e2){}
  }
}

window.addEventListener('storage', e => {
  if (e.key === STORAGE_KEY) {
    try { tasks = JSON.parse(e.newValue || '[]').map(normalizeTask); } catch(err){ tasks = []; }
    scheduleAll();
    refreshList();
  }
});

/* ICS (iOS/Android takvim) */
function pad2(n){ return String(n).padStart(2,'0'); }
function toICSDateUTC(date){
  return date.getUTCFullYear() +
    pad2(date.getUTCMonth()+1) +
    pad2(date.getUTCDate()) + 'T' +
    pad2(date.getUTCHours()) +
    pad2(date.getUTCMinutes()) +
    pad2(date.getUTCSeconds()) + 'Z';
}
function escapeICS(text){
  return String(text || '')
    .replace(/\\/g, '\\\\')
    .replace(/\n/g, '\\n')
    .replace(/,/g, '\\,')
    .replace(/;/g, '\\;');
}
function buildICS(task){
  const now = new Date();
  const uid = (task.id || ('t_'+Date.now())) + '@gorev-planlayici';

  const start = task.deadline ? new Date(task.deadline) : new Date();
  const end = new Date(start.getTime() + 30*60000);

  const dtstamp = toICSDateUTC(now);
  const dtstart = toICSDateUTC(start);
  const dtend = toICSDateUTC(end);

  const summary = escapeICS(task.title || 'Plan');
  const desc = escapeICS(task.desc || '');
  const attendeesLines = (task.attendees || []).map(e => `ATTENDEE;CN=${e}:mailto:${e}`);

  return [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//GorevPlanlayici//TR',
    'CALSCALE:GREGORIAN',
    'METHOD:PUBLISH',
    'BEGIN:VEVENT',
    'UID:' + uid,
    'DTSTAMP:' + dtstamp,
    'DTSTART:' + dtstart,
    'DTEND:' + dtend,
    'SUMMARY:' + summary,
    desc ? ('DESCRIPTION:' + desc) : '',
    ...attendeesLines,
    'END:VEVENT',
    'END:VCALENDAR'
  ].filter(Boolean).join('\r\n');
}

function makeICSBlob(task){
  const ics = buildICS(task);
  const filename = (task.title || 'plan').replace(/[^\w\-]+/g,'_').slice(0,40) + '.ics';
  const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
  return { blob, filename };
}

async function addToNativeCalendar(task){
  const { blob, filename } = makeICSBlob(task);

  try {
    const file = new File([blob], filename, { type: 'text/calendar' });
    if (navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share) {
      await navigator.share({ files: [file], title: task.title || 'Plan', text: 'Takvime eklemek i√ßin a√ß.' });
      return;
    }
  } catch(e){}

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 2000);

  alert('ICS indirildi. Dosyayƒ± a√ßƒ±p Takvim‚Äôe ekleyebilirsin.');
}

async function shareICS(task){
  const { blob, filename } = makeICSBlob(task);
  const people = (task.attendees || []).join(', ');
  const text = people
    ? `Plan payla≈üƒ±mƒ±: ${people}\n\nDosyayƒ± a√ßƒ±p Takvim'e ekleyin.`
    : `Dosyayƒ± a√ßƒ±p Takvim'e ekleyin.`;

  try {
    const file = new File([blob], filename, { type: 'text/calendar' });
    if (navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share) {
      await navigator.share({ files: [file], title: task.title || 'Plan', text });
      return;
    }
  } catch(e){}

  await addToNativeCalendar(task);
}

/* Outlook event create */
async function createOutlookEvent(task, withAttendees){
  if (!task) throw new Error('Task bulunamadƒ±');

  await ensureMsalLogin();
  const token = await getAccessToken();

  const start = task.deadline ? new Date(task.deadline) : new Date();
  const end = new Date(start.getTime() + 30*60000);
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';

  const event = {
    subject: task.title,
    body: { contentType: 'Text', content: task.desc || '' },
    start: { dateTime: start.toISOString(), timeZone: tz },
    end: { dateTime: end.toISOString(), timeZone: tz }
  };

  // ‚úÖ davetler sadece varsa eklenir, yoksa sorun √ßƒ±karmaz
  if (withAttendees && task.attendees && task.attendees.length) {
    event.attendees = task.attendees.map(email => ({
      emailAddress: { address: email },
      type: "required"
    }));
  }

  const resp = await fetch('https://graph.microsoft.com/v1.0/me/events', {
    method: 'POST',
    headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
    body: JSON.stringify(event)
  });

  if (!resp.ok) throw new Error('Graph API error: ' + resp.status + ' ' + await resp.text());
  return resp.json();
}

/* debug */
window.debug_clearAll = function(){
  localStorage.removeItem(STORAGE_KEY);
  tasks = [];
  editingId = null;
  refreshList();
};

/* init */
function saveAndRender(){ save(); refreshList(); }

</script>
</body>
</html>
